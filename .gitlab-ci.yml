default:
    image: python:3.9
    cache:
        -   key:
                files:
                    - ${CI_PROJECT_DIR}/poetry.lock
            paths:
                - ${CI_PROJECT_DIR}/.venv
        -   key: "${CI_PROJECT_ID}"
            paths:
                - ${CI_PROJECT_DIR}/.cache/pip
        -   key: "${CI_JOB_ID}"
            paths:
                - ${CI_PROJECT_DIR}/**/__pycache__/


stages:
    - ğŸ¨ format ğŸ¨
    - ğŸ¦„ quality ğŸ¦„
    - ğŸ”’ï¸ security ğŸ”’ï¸
    - ğŸ¤ test ğŸ¤
    - ğŸš€ release ğŸš€

workflow:
    rules:
        -   if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS && $CI_PIPELINE_SOURCE == "push"
            when: never
        -   if: $CI_PIPELINE_SOURCE == "merge_request_event"
        -   if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
            when: never
        -   if: $CI_COMMIT_BRANCH


variables:
    FF_USE_FASTZIP: "true"
    # These can be specified per job or per pipeline
    ARTIFACT_COMPRESSION_LEVEL: "fast"
    CACHE_COMPRESSION_LEVEL: "fast"
    PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
    VENV: "$CI_PROJECT_DIR/.venv"
    ACTIVATE_VENV: "$VENV/bin/activate"
    PYTHONPATH: "."
    GIT_STRATEGY: "fetch"
    GIT_SUBMODULE_STRATEGY: "recursive"
    ASDF_PYTHON_VERSION: "3.9"
    LM_PYTHON_VERSION: "3.9"
    SAFETY_POLICY_FILE: "$CI_PROJECT_DIR/.safety-policy.yml"
    SAFETY_COLOR: "True"

include:
    -   template: Jobs/Dependency-Scanning.gitlab-ci.yml
    -   template: Jobs/Secret-Detection.latest.gitlab-ci.yml


# Define good stage for includes

dependency_scanning:
    cache: [ ]
    stage: ğŸ”’ï¸ security ğŸ”’ï¸

.secret-analyzer:
    cache: [ ]
    stage: ğŸ”’ï¸ security ğŸ”’ï¸


# Install dependencies

ğŸ”§ build env ğŸ”§:
    cache:
        -   key:
                files:
                    - poetry.lock
            paths:
                - ${CI_PROJECT_DIR}/.venv
            policy: pull-push
        -   key: "${CI_PROJECT_ID}"
            paths:
                - ${CI_PROJECT_DIR}/.cache/pip
            policy: pull-push
    stage: .pre
    before_script:
        - python --version
        - pip install --upgrade pip
        - export PATH="$PATH":"$HOME/.local/bin"
        - pip install --user pipx
        - pipx ensurepath
        - pipx install virtualenv
        - pipx install poetry
        - poetry --version
    script:
        - virtualenv $VENV
        - source $ACTIVATE_VENV
        - pip install --upgrade pip
        - poetry install
        - poetry update
    artifacts:
        paths:
            - $VENV


# Pre script

.load_env:
    cache:
        -   key:
                files:
                    - poetry.lock
            paths:
                - ${CI_PROJECT_DIR}/.venv
            policy: pull
        -   key: "${CI_PROJECT_ID}"
            paths:
                - ${CI_PROJECT_DIR}/.cache/pip
            policy: pull
    needs:
        - ğŸ”§ build env ğŸ”§
    before_script:
        - source $ACTIVATE_VENV


# Format code

.common_format:
    extends: .load_env
    stage:
        ğŸ¨ format ğŸ¨

ğŸ©¹ isort ğŸ¨:
    extends: .common_format
    script:
        - isort src --check

ğŸ©¹ black ğŸ¨:
    extends: .common_format
    script:
        - black src --check

ğŸ©¹ yamllint ğŸ¨:
    extends: .common_format
    rules:
        -   changes:
                - $CI_PROJECT_DIR/**/*.yml
                - $CI_PROJECT_DIR/**/*.yaml
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    script:
        - yamllint src tests

ğŸ©¹ markdownlint ğŸ¨:
    cache: [ ]
    image: node:slim
    rules:
        -   changes:
                - $CI_PROJECT_DIR/**/*.md
        -   if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    stage:
        ğŸ¨ format ğŸ¨
    before_script:
        - node --version
        - npm install markdownlint
        - npm install markdownlint-cli
    script:
        - ./node_modules/markdownlint-cli/markdownlint.js src tests -j -o markdownlint.json -c .markdownlint.yaml
    artifacts:
        paths:
            - markdownlint.json


# Security check

.common_security:
    extends: .load_env
    stage: ğŸ”’ï¸ security ğŸ”’ï¸

.common_security_after_format:
    extends: .common_security
    needs:
        - !reference [ .common_security, needs ]
        - ğŸ©¹ black ğŸ¨
        - ğŸ©¹ isort ğŸ¨

ğŸ”ï¸ bandit ğŸ”’ï¸ 1/2:
    extends: .common_security_after_format
    script:
        - bandit -r src -f xml -o bandit.xml
    artifacts:
        reports:
            junit: bandit.xml

ğŸ”ï¸ bandit ğŸ”’ï¸ 2/2:
    extends: .common_security_after_format
    script:
        - bandit -r src -f html -o bandit.html
    artifacts:
        paths:
            - bandit.html

ğŸ”ï¸ mypy ğŸ·ï¸:
    extends: .common_security_after_format
    cache:
        key: "mypy-${$CI_COMMIT_BRANCH}"
        paths:
            - ${CI_PROJECT_DIR}/.mypy_cache
        policy: pull-push
    script:
        - mypy src --install-types --non-interactive --html-report html_mypy --junit-xml mypy.xml
    artifacts:
        reports:
            junit: mypy.xml
        paths:
            - html_mypy

ğŸ”ï¸ safety ğŸ”’ï¸:
    extends: .common_security
    # Ignore CVS 51457, the project uses GIT not SVN
    script:
        - safety check -i 51457 -o html --save-html safety.html -o json --save-json safety.json
    artifacts:
        paths:
            - safety.json
            - safety.html

ğŸ”ï¸ dodgy ğŸ”:
    extends: .common_security
    script:
        - dodgy src


# Quality tests

.common_quality:
    extends: .load_env
    stage: ğŸ¦„ quality ğŸ¦„
    needs:
        - !reference [ .load_env, needs ]
        - ğŸ©¹ black ğŸ¨
        - ğŸ©¹ isort ğŸ¨

ğŸ”ï¸ pycodestyle ğŸ¨:
    extends: .common_quality
    script:
        - pycodestyle src

ğŸ”ï¸ pydocstyle ğŸ“:
    extends: .common_quality
    script:
        - pydocstyle src

ğŸ”ï¸ pylint ğŸ§:
    extends: .common_quality
    script:
        - pylint src --output-format json --output pylint.json
    artifacts:
        reports:
            codequality: pylint.json

ğŸ”ï¸ ruff ğŸ§:
    extends: .common_quality
    cache:
        key: "ruff-${$CI_COMMIT_BRANCH}"
        paths:
            - ${CI_PROJECT_DIR}/.ruff_cache
        policy: pull-push
    script:
        - ruff src --format gitlab > ruff.json
    artifacts:
        reports:
            codequality: ruff.json

ğŸ”ï¸ vulture âš°ï¸:
    extends: .common_quality
    script:
        - vulture src

ğŸ”ï¸ interrogate ğŸ“:
    extends: .common_quality
    script:
        - interrogate src --generate-badge .
    artifacts:
        paths:
            - interrogate_badge.svg

ğŸ”ï¸ deptry âš°ï¸:
    extends: .load_env
    stage: ğŸ¦„ quality ğŸ¦„
    script:
        - deptry src -o deptry.json
    artifacts:
        paths:
            - deptry.json


# Tests

.common_test:
    extends: .load_env
    stage: ğŸ¤ test ğŸ¤
    cache:
        key: "pytest-${$CI_COMMIT_BRANCH}"
        paths:
            - ${CI_PROJECT_DIR}/.pytest_cache
        policy: pull-push
    before_script:
        - !reference [ .load_env, before_script ]
        - export PYTHONPATH="./src"

ğŸ¤ unittests ğŸ¤:
    extends: .common_test
    needs:
        - !reference [ .common_test, needs ]
        - ğŸ”ï¸ bandit ğŸ”’ï¸ 1/2
        - ğŸ”ï¸ bandit ğŸ”’ï¸ 2/2
        - ğŸ”ï¸ pycodestyle ğŸ¨
        - ğŸ”ï¸ pydocstyle ğŸ“
        - ğŸ”ï¸ pylint ğŸ§
        - ğŸ”ï¸ ruff ğŸ§
        - ğŸ”ï¸ mypy ğŸ·ï¸
        - ğŸ”ï¸ vulture âš°ï¸
        - ğŸ”ï¸ safety ğŸ”’ï¸
        - ğŸ”ï¸ dodgy ğŸ”
        - ğŸ”ï¸ interrogate ğŸ“
        - ğŸ”ï¸ deptry âš°ï¸
    script:
        - pytest

ğŸ¤ coverage ğŸ”ï¸:
    extends: .common_test
    needs:
        - !reference [ .common_test, needs ]
        - ğŸ¤ unittests ğŸ¤
    coverage: /TOTAL\s+[\d\.]+\s+[\d\.]+\s+[\d\.]+\s+[\d\.]+\s+([\d\.]+)/
    script:
        - pytest --cov=src --cov=tests --junit-xml=coverage.xml --cov-report=html:coverage_html
        - coverage report
    allow_failure: true
    artifacts:
        when: always
        paths:
            - coverage.xml
            - coverage_html
        reports:
            junit: coverage.xml


# Build the package

.common_release:
    stage: ğŸš€ release ğŸš€
    rules:
        # Run this job when a tag is created manually
        -   if: $CI_COMMIT_TAG && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

.load_env_for_release:
    extends:
        - .load_env
        - .common_release

ğŸ”§ build package ğŸš§:
    extends: .load_env_for_release
    needs:
        - !reference [ .load_env_for_release, needs ]
        - ğŸ¤ coverage ğŸ”ï¸
    script:
        - poetry build
    artifacts:
        when: on_success
        paths:
            - dist

ğŸ”– release package ğŸš§:
    cache: [ ]
    extends: .common_release
    needs:
        - ğŸ”§ build package ğŸš§
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    script:
        - echo "Running the release job."
    release:
        tag_name: $CI_COMMIT_TAG
        name: 'Release $CI_COMMIT_TAG'
        description: 'Release created using the release-cli.'
